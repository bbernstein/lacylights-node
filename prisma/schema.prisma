// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      String   @default("USER") // UserRole enum stored as string
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  projects ProjectUser[]
  previewSessions PreviewSession[]

  @@map("users")
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users     ProjectUser[]
  fixtures  FixtureInstance[]
  scenes    Scene[]
  cueLists  CueList[]
  previewSessions PreviewSession[]

  @@map("projects")
}

model ProjectUser {
  id       String      @id @default(cuid())
  userId   String      @map("user_id")
  projectId String     @map("project_id")
  role     String      @default("VIEWER") // ProjectRole enum stored as string
  joinedAt DateTime    @default(now()) @map("joined_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@map("project_users")
}

model FixtureDefinition {
  id           String      @id @default(cuid())
  manufacturer String
  model        String
  type         String      // FixtureType enum stored as string
  isBuiltIn    Boolean     @default(false) @map("is_built_in")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  channels  ChannelDefinition[]
  modes     FixtureMode[]
  instances FixtureInstance[]

  @@unique([manufacturer, model])
  @@map("fixture_definitions")
}

model ChannelDefinition {
  id           String      @id @default(cuid())
  name         String
  type         String      // ChannelType enum stored as string
  offset       Int
  minValue     Int         @default(0) @map("min_value")
  maxValue     Int         @default(255) @map("max_value")
  defaultValue Int         @default(0) @map("default_value")
  definitionId String      @map("definition_id")

  definition   FixtureDefinition @relation(fields: [definitionId], references: [id], onDelete: Cascade)
  modeChannels ModeChannel[]

  @@map("channel_definitions")
}

model FixtureMode {
  id           String @id @default(cuid())
  name         String
  shortName    String? @map("short_name")
  channelCount Int     @map("channel_count")
  definitionId String  @map("definition_id")

  definition   FixtureDefinition @relation(fields: [definitionId], references: [id], onDelete: Cascade)
  modeChannels ModeChannel[]

  @@unique([definitionId, name])
  @@map("fixture_modes")
}

model ModeChannel {
  id        String @id @default(cuid())
  modeId    String @map("mode_id")
  channelId String @map("channel_id")
  offset    Int

  mode    FixtureMode       @relation(fields: [modeId], references: [id], onDelete: Cascade)
  channel ChannelDefinition @relation(fields: [channelId], references: [id])

  @@unique([modeId, offset])
  @@map("mode_channels")
}

model FixtureInstance {
  id           String       @id @default(cuid())
  name         String
  description  String?

  // Fixture Definition Reference
  definitionId String       @map("definition_id")
  manufacturer String?      // Denormalized from definition
  model        String?      // Denormalized from definition
  type         String?      // FixtureType enum stored as string

  // Flattened Mode Information
  modeName     String?      @map("mode_name")
  channelCount Int?         @map("channel_count")

  // DMX Configuration
  projectId    String       @map("project_id")
  universe     Int
  startChannel Int          @map("start_channel")
  tags         String?      @default("[]") // JSON-serialized string array stored as string

  // Ordering
  projectOrder Int?         @map("project_order") // Order within project fixture list

  // 2D Layout Position (normalized 0-1 coordinates)
  layoutX       Float?      @map("layout_x")       // X position 0-1, null = auto-layout
  layoutY       Float?      @map("layout_y")       // Y position 0-1, null = auto-layout
  layoutRotation Float?     @map("layout_rotation") // Rotation in degrees (0-360)

  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relations
  definition    FixtureDefinition @relation(fields: [definitionId], references: [id])
  project       Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  channels      InstanceChannel[]
  fixtureValues FixtureValue[]

  @@unique([projectId, universe, startChannel])
  @@map("fixture_instances")
}

model Scene {
  id          String   @id @default(cuid())
  name        String
  description String?
  projectId   String   @map("project_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  fixtureValues FixtureValue[]
  cues          Cue[]

  @@map("scenes")
}

model FixtureValue {
  id            String @id @default(cuid())
  sceneId       String @map("scene_id")
  fixtureId     String @map("fixture_id")
  channelValues String @default("[]") // JSON array of 0-255 values stored as string
  sceneOrder    Int?   @map("scene_order") // Order within this scene's fixture list

  scene   Scene           @relation(fields: [sceneId], references: [id], onDelete: Cascade)
  fixture FixtureInstance @relation(fields: [fixtureId], references: [id], onDelete: Cascade)

  @@unique([sceneId, fixtureId])
  @@map("fixture_values")
}

model InstanceChannel {
  id           String      @id @default(cuid())
  fixtureId    String      @map("fixture_id")
  offset       Int
  name         String
  type         String      // ChannelType enum stored as string
  minValue     Int         @default(0) @map("min_value")
  maxValue     Int         @default(255) @map("max_value")
  defaultValue Int         @default(0) @map("default_value")

  fixture FixtureInstance @relation(fields: [fixtureId], references: [id], onDelete: Cascade)

  @@unique([fixtureId, offset])
  @@map("instance_channels")
}


model CueList {
  id          String   @id @default(cuid())
  name        String
  description String?
  loop        Boolean  @default(false) // Whether to loop back to first cue after last cue
  projectId   String   @map("project_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  cues    Cue[]

  @@map("cue_lists")
}

model Cue {
  id          String      @id @default(cuid())
  name        String
  cueNumber   Float       @map("cue_number")
  cueListId   String      @map("cue_list_id")
  sceneId     String      @map("scene_id")
  fadeInTime  Float       @default(0) @map("fade_in_time")
  fadeOutTime Float       @default(0) @map("fade_out_time")
  followTime  Float?      @map("follow_time")
  easingType  String?     @map("easing_type") // EasingType enum stored as string
  notes       String?
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  cueList CueList @relation(fields: [cueListId], references: [id], onDelete: Cascade)
  scene   Scene   @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  @@unique([cueListId, cueNumber])
  @@map("cues")
}

model PreviewSession {
  id        String   @id @default(cuid())
  projectId String   @map("project_id")
  userId    String   @map("user_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("preview_sessions")
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

// SQLite doesn't support enums, so we store them as strings
// The application layer validates these values

// UserRole: "ADMIN" | "USER"
// ProjectRole: "OWNER" | "EDITOR" | "VIEWER"
// FixtureType: "LED_PAR" | "MOVING_HEAD" | "STROBE" | "DIMMER" | "OTHER"
// ChannelType: "INTENSITY" | "RED" | "GREEN" | "BLUE" | "WHITE" | "AMBER" | "UV" | "PAN" | "TILT" | "ZOOM" | "FOCUS" | "IRIS" | "GOBO" | "COLOR_WHEEL" | "EFFECT" | "STROBE" | "MACRO" | "OTHER"
// EasingType: "LINEAR" | "EASE_IN_OUT_CUBIC" | "EASE_IN_OUT_SINE" | "EASE_OUT_EXPONENTIAL" | "BEZIER" | "S_CURVE"