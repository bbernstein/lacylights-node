name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]

jobs:
  validate:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch full history for better diff analysis
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run pre-commit checks
        run: |
          # Run the same checks as pre-commit hook
          npm run lint
          npm run build

      - name: Check for breaking changes
        run: |
          echo "Checking for potential breaking changes..."
          # Check if package.json dependencies changed
          if git diff --name-only ${{ github.event.pull_request.base.sha }}..HEAD | grep -q "package.json"; then
            echo "⚠️ package.json changed - review dependencies"
          fi
          
          # Check if database schema changed
          if git diff --name-only ${{ github.event.pull_request.base.sha }}..HEAD | grep -q "prisma/schema.prisma"; then
            echo "⚠️ Database schema changed - may require migration"
          fi
          
          # Check if environment variables changed
          if git diff --name-only ${{ github.event.pull_request.base.sha }}..HEAD | grep -q ".env.example"; then
            echo "ℹ️ Environment configuration changed"
          fi

      - name: Validate commit messages
        run: |
          # Check if commits follow conventional commit format (optional)
          echo "Validating commit messages..."
          git log --oneline ${{ github.event.pull_request.base.sha }}..HEAD | while read commit; do
            echo "✓ $commit"
          done

      - name: Check file sizes
        run: |
          # Check for large files that shouldn't be committed
          echo "Checking for large files..."
          find . -type f -size +10M ! -path "./node_modules/*" ! -path "./.git/*" | while read file; do
            echo "⚠️ Large file detected: $file"
          done || echo "✓ No large files found"

      - name: PR Validation Summary
        run: |
          echo "## PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ ESLint passed" >> $GITHUB_STEP_SUMMARY
          echo "✅ TypeScript compilation passed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Pre-commit checks passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This PR is ready for review! 🚀" >> $GITHUB_STEP_SUMMARY